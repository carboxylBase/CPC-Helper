
==================================================
File: src/utils/history.ts
==================================================

// å®šä¹‰å†å²è®°å½•çš„æ•°æ®ç»“æ„: { "YYYY-MM-DD": æ€»é¢˜æ•° }
export interface ActivityHistory {
  [date: string]: number;
}

// å®šä¹‰æ¯æ—¥å¢é‡æ•°æ®: { date: "YYYY-MM-DD", count: ä»Šæ—¥åšé¢˜æ•°, level: çƒ­åŠ›ç­‰çº§ }
export interface DailyActivity {
  date: string;
  count: number;
  level: 0 | 1 | 2 | 3 | 4;
}

const HISTORY_KEY = 'cpc_activity_history';

// è·å–æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
export const getTodayStr = () => {
  const d = new Date();
  const year = d.getFullYear();
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// æ ¸å¿ƒé€»è¾‘ï¼šæ›´æ–°ä»Šæ—¥å¿«ç…§
export const updateActivitySnapshot = (currentTotalSolved: number) => {
  if (currentTotalSolved === 0) return; // å¿½ç•¥æ— æ•ˆæ•°æ®

  const today = getTodayStr();
  const saved = localStorage.getItem(HISTORY_KEY);
  let history: ActivityHistory = saved ? JSON.parse(saved) : {};

  // å¦‚æœä»Šå¤©çš„è®°å½•æ¯”ç°åœ¨çš„å°‘ï¼ˆæˆ–è€…ä¸å­˜åœ¨ï¼‰ï¼Œæˆ–è€…ç°åœ¨çš„æ›´å¤šï¼ˆè¯´æ˜åˆšåšäº†ä¸€é¢˜ï¼‰ï¼Œåˆ™æ›´æ–°
  // æ³¨æ„ï¼šæˆ‘ä»¬åªè®°å½•"æœ€å¤§å€¼"ï¼Œé˜²æ­¢APIå¶å°”å¤±è´¥è¿”å›0å¯¼è‡´æ•°æ®å›æ»š
  const recordedToday = history[today] || 0;
  if (currentTotalSolved > recordedToday) {
    history[today] = currentTotalSolved;
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  }
  
  return history;
};

// æ ¸å¿ƒé€»è¾‘ï¼šè®¡ç®—å¢é‡ (çƒ­åŠ›å›¾æ•°æ®)
export const calculateDailyActivity = (): DailyActivity[] => {
  const saved = localStorage.getItem(HISTORY_KEY);
  if (!saved) return [];

  const history: ActivityHistory = JSON.parse(saved);
  // æŒ‰æ—¥æœŸæ’åº
  const sortedDates = Object.keys(history).sort();
  
  const activities: DailyActivity[] = [];
  
  // ç”Ÿæˆè¿‡å» 365 å¤©çš„ç©ºæ¡£ï¼Œå¡«è¡¥ä¸­é—´ç¼ºå¤±çš„æ—¥æœŸ
  const today = new Date();
  const oneYearAgo = new Date();
  oneYearAgo.setDate(today.getDate() - 365);

  // æˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªå®Œæ•´çš„æ—¥æœŸæ˜ å°„
  const dateMap = new Map<string, number>();
  
  // è®¡ç®—æ¯ä¸€å¤©çš„å¢é‡
  for (let i = 0; i < sortedDates.length; i++) {
    const dateStr = sortedDates[i];
    const total = history[dateStr];
    
    // å¯»æ‰¾å‰ä¸€ä¸ªæœ‰æ•ˆè®°å½•
    let prevTotal = 0;
    if (i > 0) {
      prevTotal = history[sortedDates[i-1]];
    } else {
      // å¦‚æœæ˜¯ç¬¬ä¸€æ¡è®°å½•ï¼Œä¸”è®°å½•æ—¶é—´å°±åœ¨æœ€è¿‘ï¼Œæˆ‘ä»¬å‡è®¾å¢é‡å°±æ˜¯å½“æ—¥æ‰€æœ‰çš„ï¼ˆæˆ–è€…0ï¼Œè§†ç­–ç•¥è€Œå®šï¼‰
      // ä¸ºäº†é¿å…åˆæ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤º "+2000é¢˜"ï¼Œæˆ‘ä»¬é€šå¸¸æŠŠç¬¬ä¸€å¤©å¢é‡è®¾ä¸º 0ï¼Œé™¤éæ•°æ®é•¿æœŸå­˜åœ¨
      prevTotal = total; // ç­–ç•¥ï¼šç¬¬ä¸€å¤©ä¸ç®—å¢é‡
    }

    const delta = Math.max(0, total - prevTotal);
    dateMap.set(dateStr, delta);
  }

  // å¡«å……è¿‡å»365å¤©çš„æ•°æ®
  for (let d = new Date(oneYearAgo); d <= today; d.setDate(d.getDate() + 1)) {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    const isoDate = `${year}-${month}-${day}`;

    const count = dateMap.get(isoDate) || 0;
    
    // è®¡ç®—çƒ­åŠ›ç­‰çº§
    let level: 0 | 1 | 2 | 3 | 4 = 0;
    if (count > 0) level = 1;
    if (count > 2) level = 2;
    if (count > 5) level = 3;
    if (count > 9) level = 4;

    activities.push({ date: isoDate, count, level });
  }

  return activities;
};

// ç»Ÿè®¡æœ€è¿‘ N å¤©çš„æ€»æ•°
export const getRecentSum = (days: number): number => {
  const activities = calculateDailyActivity();
  // å–æœ€å N ä¸ªå…ƒç´ 
  return activities.slice(-days).reduce((acc, curr) => acc + curr.count, 0);
};

==================================================
File: src/components/ActivityHeatmap.tsx
==================================================

import React, { useMemo } from 'react';
import { DailyActivity } from '../utils/history';

interface ActivityHeatmapProps {
  data: DailyActivity[];
  cardStyle: any;
}

const ActivityHeatmap: React.FC<ActivityHeatmapProps> = ({ data, cardStyle }) => {
  
  // --- ç»Ÿè®¡æ•°æ®è®¡ç®— (åŸºäºä¼ å…¥çš„ data æ•°ç»„) ---

  // 1. æ˜¨æ—¥åšé¢˜æ•°
  const yesterdayCount = useMemo(() => {
    if (data.length < 2) return 0;
    // data æ•°ç»„æŒ‰æ—¥æœŸå‡åºæ’åˆ—ï¼Œæœ€åä¸€ä¸ªæ˜¯ä»Šå¤©ï¼Œå€’æ•°ç¬¬äºŒä¸ªæ˜¯æ˜¨å¤©
    return data[data.length - 2].count;
  }, [data]);

  // 2. æœ€è¿‘ 7 å¤©åšé¢˜æ•°
  const lastWeekCount = useMemo(() => {
    return data.slice(-7).reduce((acc, curr) => acc + curr.count, 0);
  }, [data]);

  // 3. æœ€è¿‘ 30 å¤©åšé¢˜æ•°
  const lastMonthCount = useMemo(() => {
    return data.slice(-30).reduce((acc, curr) => acc + curr.count, 0);
  }, [data]);

  // 4. æœ€è¿‘ä¸€å¹´åšé¢˜æ•°
  const lastYearCount = useMemo(() => {
    return data.slice(-365).reduce((acc, curr) => acc + curr.count, 0);
  }, [data]);

  // --- çƒ­åŠ›å›¾æ•°æ®å¤„ç† ---
  // å°†æ•°æ®æŒ‰å‘¨åˆ†ç»„ï¼ˆä¸ºäº†çºµå‘æ’åˆ—ï¼šå‘¨æ—¥->å‘¨å…­ï¼‰
  const weeks = useMemo(() => {
    const result: DailyActivity[][] = [];
    let currentWeek: DailyActivity[] = [];

    data.forEach((day) => {
      const dateObj = new Date(day.date);
      // å¦‚æœæ˜¯å‘¨æ—¥ä¸”å½“å‰å‘¨ä¸ä¸ºç©ºï¼Œå¼€å¯æ–°çš„ä¸€å‘¨
      if (dateObj.getDay() === 0 && currentWeek.length > 0) {
        result.push(currentWeek);
        currentWeek = [];
      }
      currentWeek.push(day);
    });
    if (currentWeek.length > 0) result.push(currentWeek);
    
    // æˆªå–æœ€è¿‘çš„ 52 å‘¨ç”¨äºæ˜¾ç¤º
    return result.slice(-52); 
  }, [data]);

  // é¢œè‰²æ˜ å°„
  const getLevelColor = (level: number) => {
    switch (level) {
      case 1: return '#0e4429'; // å°‘é‡ (æ·±ç»¿)
      case 2: return '#006d32'; // ä¸­ç­‰
      case 3: return '#26a641'; // è¾ƒå¤š
      case 4: return '#39d353'; // å¾ˆå¤š (äº®ç»¿)
      default: return 'rgba(255, 255, 255, 0.05)'; // æ— æ•°æ® (ç°è‰²)
    }
  };

  // ç»Ÿè®¡å¡ç‰‡ç»„ä»¶
  const StatCard = ({ label, value }: { label: string, value: number }) => (
    <div className="bg-black/20 px-3 py-2 rounded-lg border border-white/5 flex flex-col items-center justify-center min-w-[80px]">
      <span className="text-[10px] text-gray-400 uppercase tracking-wider mb-0.5">{label}</span>
      <div className="flex items-baseline gap-1">
        <span className="text-lg font-bold text-white">{value}</span>
        <span className="text-[10px] text-gray-500">problems</span>
      </div>
    </div>
  );

  return (
    <div className="rounded-2xl p-6 border border-white/5 mt-6" style={cardStyle}>
      <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-6">
        <h3 className="text-lg font-bold text-white/90 flex items-center gap-2">
          <span>ğŸ”¥</span> Activity Heatmap
        </h3>
        
        {/* ç»Ÿè®¡æ¦‚è§ˆ - Grid å¸ƒå±€é€‚é…ä¸åŒå±å¹• */}
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 w-full lg:w-auto">
           <StatCard label="Yesterday" value={yesterdayCount} />
           <StatCard label="Last 7 Days" value={lastWeekCount} />
           <StatCard label="Last 30 Days" value={lastMonthCount} />
           <StatCard label="Last Year" value={lastYearCount} />
        </div>
      </div>

      {/* çƒ­åŠ›å›¾æ»šåŠ¨å®¹å™¨ */}
      <div className="overflow-x-auto pb-2 custom-scrollbar">
        <div className="flex gap-1 min-w-max">
          {weeks.map((week, wIndex) => (
            <div key={wIndex} className="flex flex-col gap-1">
              {week.map((day) => (
                <div
                  key={day.date}
                  className="w-3 h-3 rounded-[2px] transition-all hover:ring-1 hover:ring-white relative group"
                  style={{ backgroundColor: getLevelColor(day.level) }}
                >
                  {/* Tooltip */}
                  <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover:block z-50 whitespace-nowrap bg-gray-900 text-xs text-white px-2 py-1 rounded border border-white/10 shadow-xl pointer-events-none">
                    {day.count} problems on {day.date}
                  </div>
                </div>
              ))}
            </div>
          ))}
        </div>
      </div>

      {/* å›¾ä¾‹ */}
      <div className="flex items-center justify-end gap-2 mt-4 text-xs text-gray-500">
        <span>Less</span>
        <div className="w-3 h-3 rounded-[2px]" style={{ background: 'rgba(255, 255, 255, 0.05)' }}></div>
        <div className="w-3 h-3 rounded-[2px]" style={{ background: '#0e4429' }}></div>
        <div className="w-3 h-3 rounded-[2px]" style={{ background: '#006d32' }}></div>
        <div className="w-3 h-3 rounded-[2px]" style={{ background: '#26a641' }}></div>
        <div className="w-3 h-3 rounded-[2px]" style={{ background: '#39d353' }}></div>
        <span>More</span>
      </div>
    </div>
  );
};

export default ActivityHeatmap;
